localStorage.setItem('products', JSON.stringify([
    { ID: 1, name: "Gà Rán", price: "99,000 VND", img: "image/Product_Menu/Gà_Rán.png", category: "Gà" },
    { ID: 2, name: "Burger Gà", price: "75,000 VND", img: "image/Product_Menu/Burger_Gà.png", category: "Burger" },
    { ID: 3, name: "Gà Quay", price: "89,000 VND", img: "image/Product_Menu/Gà_quay.png", category: "Gà" },
    { ID: 4, name: "Phi-lê Gà Quay", price: "95,000 VND", img: "image/Product_Menu/Phi-lê Gà Quay.jpg", category: "Gà" },
    { ID: 5, name: "Gà Không Xương", price: "85,000 VND", img: "image/Product_Menu/Gà_Ko_xương.png", category: "Gà" },
    { ID: 6, name: "Đùi Gà Quay", price: "105,000 VND", img: "image/Product_Menu/Đùi_gà_quay.png", category: "Gà" },
    { ID: 7, name: "Gà Chiên Xù", price: "110,000 VND", img: "image/Product_Menu/Gà_Chiên_Xù.jpg", category: "Gà" },
    { ID: 8, name: "Gà Sốt BBQ", price: "120,000 VND", img: "image/Product_Menu/Gà_sốt_BBQ.png", category: "Gà" },
    { ID: 9, name: "Gà Sốt Cay", price: "130,000 VND", img: "image/Product_Menu/Gà_sốt_cay.png", category: "Gà" },
    { ID: 10, name: "Gà Sốt Mật Ong", price: "140,000 VND", img: "image/Product_Menu/Gà_sốt_mật_ong.png", category: "Gà" },
    { ID: 11, name: "Mì Ý Gà Zinger", price: "150,000 VND", img: "image/Product_Menu/Mì_Ý_gà_Zinger.png", category: "Mì Ý" },
    { ID: 12, name: "Gà Sốt Chanh", price: "160,000 VND", img: "image/Product_Menu/gà_sốt_chanh.png", category: "Gà" },
    { ID: 13, name: "Khoai Tây Nghiền (Vừa)", price: "170,000 VND", img: "image/Product_Menu/Khoai Tây Nghiền (Vừa).png", category: "Khoai Tây" },
    { ID: 14, name: "Gà Sốt Dứa", price: "180,000 VND", img: "image/Product_Menu/Gà_sốt_dứa.png", category: "Gà" },
    { ID: 15, name: "Khoai Tây Nghiền (Lớn)", price: "190,000 VND", img: "image/Product_Menu/Khoai Tây Nghiền (Lớn).png", category: "Khoai Tây" },
    { ID: 16, name: "Gà Sốt Dâu", price: "200,000 VND", img: "image/Product_Menu/Gà_sốt_dâu.png", category: "Gà" },
    { ID: 17, name: "Khoai Tây Nghiền (Đại)", price: "210,000 VND", img: "image/Product_Menu/Khoai Tây Nghiền (Đại).png", category: "Khoai Tây" },
    { ID: 18, name: "Khoai Tây Chiên (Vừa)", price: "80,000 VND", img: "image/Product_Menu/Khoai_tây_chiên_Vừa.png", category: "Khoai Tây" },
    { ID: 19, name: "Khoai Tây Chiên (Lớn)", price: "85,000 VND", img: "image/Product_Menu/Khoai Tây Chiên (Lớn).png", category: "Khoai Tây" },
    { ID: 20, name: "Khoai Tây Chiên (Đại)", price: "90,000 VND", img: "image/Product_Menu/Khoai Tây Chiên (Đại).png", category: "Khoai Tây" },
    { ID: 21, name: "Burger Bò", price: "95,000 VND", img: "image/Product_Menu/Burger Bò.png", category: "Burger" },
    { ID: 22, name: "Burger Phô Mai", price: "100,000 VND", img: "image/Product_Menu/Burger_Phô_mai.png", category: "Burger" },
    { ID: 23, name: "Burger Cá", price: "105,000 VND", img: "image/Product_Menu/Burger_cá.png", category: "Burger" },
    { ID: 24, name: "Mì Ý Sốt Bò", price: "110,000 VND", img: "image/Product_Menu/Mì Ý Sốt Bò.png", category: "Mì Ý" },
    { ID: 25, name: "Bắp Cải Trộn (Vừa)", price: "115,000 VND", img: "image/Product_Menu/Bắp Cải Trộn (Vừa).png", category: "Bắp Cải" },
    { ID: 26, name: "Bắp Cải Trộn (Lớn)", price: "120,000 VND", img: "image/Product_Menu/Bắp Cảii Trộn (Lớn).png", category: "Bắp Cải" },
    { ID: 27, name: "Bắp Cải Trộn (Đại)", price: "125,000 VND", img: "image/Product_Menu/Bắp Cải Trộn (Đại).png", category: "Bắp Cải" },
    { ID: 28, name: "Combo Gà Nướng", price: "130,000 VND", img: "image/Product_Menu/Combo Gà Nướn.png", category: "Combo" },
    { ID: 29, name: "Mì Ý Phi-Lê Gà Quay", price: "135,000 VND", img: "image/Product_Menu/Mì Ý Phi-Lê Gà Quay.png", category: "Mì Ý" },
    { ID: 30, name: "Combo Gà Sốt BBQ", price: "140,000 VND", img: "image/Product_Menu/Combo Gà Sốt BBQ.png", category: "Combo" },
    { ID: 31, name: "Combo Gà Sốt Cay", price: "145,000 VND", img: "image/Product_Menu/Combo Gà Sốt Cay.png", category: "Combo" },
    { ID: 32, name: "Salad Hạt", price: "150,000 VND", img: "image/Product_Menu/Salad Hạt.png", category: "Salad" },
    { ID: 33, name: "Salad Pop", price: "155,000 VND", img: "image/Product_Menu/Salad Pop.png", category: "Salad" },
    { ID: 34, name: "Mì Ý Gà Rán", price: "160,000 VND", img: "image/Product_Menu/Mì Ý Gà Rán.png", category: "Mì Ý" },
    { ID: 35, name: "3 Cá Thanh", price: "165,000 VND", img: "image/Product_Menu/3 Cá Thanh.png", category: "Cá" },
    { ID: 36, name: "Combo Gà Sốt Dứa", price: "170,000 VND", img: "image/Product_Menu/Combo Gà Sốt Dứa.png", category: "Combo" },
    { ID: 37, name: "Combo Gà Sốt Xoài", price: "175,000 VND", img: "image/Product_Menu/Combo Gà Sốt Xoài.png", category: "Combo" },
    { ID: 38, name: "Combo Gà Sốt Dâu", price: "180,000 VND", img: "image/Product_Menu/Combo Gà Sốt Dâu.png", category: "Combo" },
    { ID: 39, name: "4 Phô Mai Viên", price: "185,000 VND", img: "image/Product_Menu/4 Phô Mai Viên.png", category: "Phô Mai" },
    { ID: 40, name: "Combo Gà Sốt Dừa", price: "190,000 VND", img: "image/Product_Menu/Combo Gà Sốt Dừa.png", category: "Combo" }
]));


let cart = [];

function openCart() {
    const cartModal = document.getElementById('cartModal');
    const overlay = document.getElementById('pageOverlay');

    if (cartModal) {
        cartModal.style.display = 'block';
    }

    cartModal.style.display = 'block';
    overlay.style.display = 'block';
    cartModal.classList.remove('hide');
    cartModal.classList.add('show');
    document.body.style.overflow = 'hidden'; // Ngăn cuộn trang khi mở giỏ hàng
}

function closeCart() {
    const cartModal = document.getElementById('cartModal');
    const overlay = document.getElementById('pageOverlay');
    cartModal.classList.remove('show');
    cartModal.classList.add('hide');
    setTimeout(() => {
        cartModal.style.display = 'none';
        overlay.style.display = 'none';
        document.body.style.overflow = 'auto'; // Cho phép cuộn trang trở lại bình thường

    }, 500); // Thời gian trùng với thời gian của animation
}

function isLoggedIn() {
    const user = localStorage.getItem('loggedInUser');
    console.log('User in localStorage:', user); // Thêm dòng này để kiểm tra giá trị của user
    return !!user;
}


// Hàm lưu sản phẩm vào LocalStorage
function saveProduct(product) {
    let products = localStorage.getItem('products');
    products = products ? JSON.parse(products) : [];

    products.push(product);
    localStorage.setItem('products', JSON.stringify(products));
}


function addToCart(productId, quantity) {
    // Kiểm tra xem người dùng đã đăng nhập chưa
    if (!isLoggedIn()) {
        alert('Bạn cần đăng nhập để thêm sản phẩm vào giỏ hàng.');
        return;
    }

    // Lấy danh sách sản phẩm từ localStorage
    let products = localStorage.getItem('products');
    products = products ? JSON.parse(products) : [];

    // Tìm sản phẩm dựa trên productId
    const product = products.find(p => p.ID === parseInt(productId));
    if (!product) {
        alert('Sản phẩm không tồn tại.');
        console.log('Không tìm thấy sản phẩm với ID:', productId); // In ra để debug
        return;
    }

    // Lấy thông tin người dùng đang đăng nhập từ localStorage
    let loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!loggedInUser) {
        alert('Bạn cần đăng nhập để thêm sản phẩm vào giỏ hàng.');
        return;
    }

    // Khởi tạo giỏ hàng nếu chưa có
    if (!loggedInUser.cart) {
        loggedInUser.cart = [];
    }

    // Kiểm tra xem sản phẩm đã có trong giỏ hàng chưa
    let existingProduct = loggedInUser.cart.find(item => item.ID === product.ID);
    if (existingProduct) {
        // Nếu sản phẩm đã có trong giỏ hàng, tăng số lượng
        existingProduct.soluong += quantity;
    } else {
        // Nếu chưa có, thêm sản phẩm mới vào giỏ hàng
        loggedInUser.cart.push({
            ID: product.ID,
            name: product.name,
            price: product.price,
            img: product.img,
            soluong: quantity,
            note: "Không có ghi chú" // Thêm ghi chú mặc định
        });
    }

    // Lưu lại thông tin người dùng vào localStorage
    localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));

    // Cập nhật thông báo cho người dùng
    alert('Sản phẩm đã được thêm vào giỏ hàng.');

    updateCart();
}

// Khởi tạo mảng sản phẩm nếu chưa tồn tại trong localStorage
if (!localStorage.getItem('products')) {
    localStorage.setItem('products', JSON.stringify([]));
}


//cập nhật giỏ hàng
function updateCart() {
    const cartItems = document.getElementById('cart-items');
    const cartCount = document.getElementById('cart-count');
    const totalPriceElement = document.getElementById('total-price');
    const checkoutButton = document.getElementById('checkout-btn');
    const gioHangTrong = document.getElementById('empty-cart');

    cartItems.innerHTML = '';
    let total = 0;
    let totalItems = 0;

    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!loggedInUser || !loggedInUser.cart || loggedInUser.cart.length === 0) {
        if (gioHangTrong) {
            gioHangTrong.style.display = 'block';  // Kiểm tra trước khi thay đổi style
        }
        totalPriceElement.innerText = '0₫';
        checkoutButton.disabled = true;
        cartCount.innerText = 0;  // Đảm bảo cartCount là 0 khi giỏ hàng rỗng
        return;
    }

    loggedInUser.cart.forEach(item => {
        const numericPrice = parseFloat(item.price.replace(/[^0-9.-]+/g, "").replace(",", ""));
        const itemElement = document.createElement('div');
        itemElement.classList.add('cart-item');
        itemElement.innerHTML = `
        <div class="product-container">
           <div class="product-img">
               <img src="${item.img}" alt="${item.name}">
           </div>
           <div class="product-detail">
               <span>${item.name}</span>
               <span>${numericPrice.toLocaleString()}₫</span>
               <div class="quantity-controls">
                   <button class="btn-decrement">-</button>
                   <span class="quantity">${item.soluong}</span>
                   <button class="btn-increment">+</button>
               </div>
           </div>
           <div class="remove-btn">
               <button onclick="removeFromCart(${item.ID})">Xóa</button>
           </div>       
        </div>
        `;
        cartItems.appendChild(itemElement);

        total += numericPrice * item.soluong;
        totalItems += item.soluong;
        cartCount.innerText = totalItems; // Cập nhật lại số lượng giỏ hàng
    });

    totalPriceElement.innerText = `${total.toLocaleString()}₫`;
    if (gioHangTrong) {
        gioHangTrong.style.display = 'none';  // Kiểm tra trước khi thay đổi style
    }

    // Kích hoạt lại nút thanh toán nếu có sản phẩm trong giỏ hàng
    if (checkoutButton && loggedInUser.cart.length > 0) {
        checkoutButton.disabled = false;
    }

    // Add event listeners for increment and decrement buttons
    const incrementButtons = document.querySelectorAll('.btn-increment');
    const decrementButtons = document.querySelectorAll('.btn-decrement');

    incrementButtons.forEach(button => {
        button.addEventListener('click', function () {
            const productId = this.closest('.cart-item').querySelector('.remove-btn button').getAttribute('onclick').match(/\d+/)[0];
            updateQuantity(productId, 1);
        });
    });

    decrementButtons.forEach(button => {
        button.addEventListener('click', function () {
            const productId = this.closest('.cart-item').querySelector('.remove-btn button').getAttribute('onclick').match(/\d+/)[0];
            updateQuantity(productId, -1);
        });
    });
}

function updateQuantity(productId, change) {
    let loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!loggedInUser || !loggedInUser.cart) {
        console.error("No logged-in user or cart found.");
        return;
    }

    let product = loggedInUser.cart.find(item => item.ID === parseInt(productId));
    if (product) {
        product.soluong += change;
        if (product.soluong <= 0) {
            removeFromCart(productId);
        } else {
            localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
            updateCart();
        }
    }
}

function removeFromCart(productId) {
    let loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!loggedInUser || !loggedInUser.cart) {
        console.error("No logged-in user or cart found.");
        return;
    }

    // Lọc bỏ sản phẩm khỏi giỏ hàng của loggedInUser dựa trên productId
    loggedInUser.cart = loggedInUser.cart.filter(item => item.ID !== productId);

    // Lưu lại thông tin người dùng đã cập nhật vào localStorage
    localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));

    // Cập nhật giỏ hàng trên giao diện
    updateCart();
}

// Hàm mở form thông tin giao hàng
function showShippingForm() {
    console.log('showShippingForm function called'); // Add this line to check if the function is called
    const cartModal = document.getElementById('cartModal');
    const shippingModal = document.getElementById('shippingFormModal');
    const overlay = document.getElementById('pageOverlay'); // Lấy lớp phủ
    const shippingCartItems = document.getElementById('shipping-cart-items');
    const shippingTotalPrice = document.getElementById('shipping-total-price');

    if (cartModal && shippingModal && overlay && shippingCartItems && shippingTotalPrice) {
        console.log('All elements found'); // Add this line to check if all elements are found
        cartModal.classList.remove('show');
        cartModal.style.display = 'none'; // Ẩn giỏ hàng
        shippingModal.style.display = 'block'; // Hiển thị form giao hàng
        shippingModal.classList.add('show');

        overlay.style.display = 'block'; // Hiển thị lớp phủ
        document.body.style.overflow = 'hidden'; // Khóa cuộn trang

        // Hiển thị các sản phẩm trong giỏ hàng
        const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
        if (loggedInUser && loggedInUser.cart) {
            console.log('Logged in user and cart found'); // Add this line to check if logged in user and cart are found
            shippingCartItems.innerHTML = '';
            let total = 0;
            loggedInUser.cart.forEach(item => {
                const numericPrice = parseFloat(item.price.replace(/[^0-9.-]+/g, "").replace(",", ""));
                const itemElement = document.createElement('div');
                itemElement.classList.add('cart-item');
                itemElement.innerHTML = `
                <div class="product-container">
                   <div class="product-img">
                       <img src="${item.img}" alt="${item.name}">
                   </div>
                   <div class="product-detail">
                       <span>${item.name}</span>
                       <span>${numericPrice.toLocaleString()}₫</span>
                       <span>SL: ${item.soluong}</span>
                   </div>     
                </div>
                `;
                shippingCartItems.appendChild(itemElement);
                total += numericPrice * item.soluong;
            });
            shippingTotalPrice.innerText = `${total.toLocaleString()}₫`;
        }
    } else {
        console.error('One or more elements not found'); // Add this line to check if any element is not found
    }
}

// Hàm đóng form thông tin giao hàng
function closeShippingForm() {
    const shippingModal = document.getElementById('shippingFormModal');
    const overlay = document.getElementById('pageOverlay');

    if (shippingModal && overlay) {
        shippingModal.classList.remove('show');
        shippingModal.classList.add('hide');

        setTimeout(() => {
            shippingModal.style.display = 'none'; // Ẩn form
            overlay.style.display = 'none'; // Ẩn lớp phủ
            document.body.style.overflow = 'auto'; // Bật cuộn trang
        }, 500); // Khớp với thời gian animation
    }
}

const cartModal = document.getElementById('cartModal');
const overlay = document.getElementById('pageOverlay');
cartModal.classList.remove('show');
cartModal.classList.add('hide');

// Hàm trở về giỏ hàng từ form thông tin giao hàng
function backToCart() {
    const cartModal = document.getElementById('cartModal');
    const shippingModal = document.getElementById('shippingFormModal');
    const overlay = document.getElementById('pageOverlay');
    if (cartModal && shippingModal && overlay) {
        shippingModal.classList.remove('show');
        shippingModal.style.display = 'none'; // Ẩn form giao hàng
        cartModal.style.display = 'block'; // Hiển thị lại giỏ hàng
        cartModal.classList.add('show');
        overlay.style.display = 'block'; // Hiển thị lớp phủ
    }
}

// Hàm hiển thị hoặc ẩn thông tin thẻ tín dụng
function toggleCreditCardFields() {
    const paymentMethod = document.getElementById('payment-method').value;
    const creditCardInfo = document.getElementById('credit-card-info');
    if (paymentMethod === 'credit-card') {
        creditCardInfo.style.display = 'block';
    } else {
        creditCardInfo.style.display = 'none';
    }
}

// Handle the shipping form submission
document.getElementById('shipping-form').addEventListener('submit', function (event) {
    event.preventDefault();

    const fullName = document.getElementById('full-name').value;
    const phoneNumber = document.getElementById('phone-number').value;
    const email = document.getElementById('email').value;
    const address = document.getElementById('address').value;
    const paymentMethod = document.getElementById('payment-method').value;

    // Handle the form data as needed, e.g., send it to the server or store it in localStorage
    console.log({
        fullName,
        phoneNumber,
        email,
        address,
        paymentMethod
    });

    // Show a success message
    alert('Đặt hàng thành công!');

    // Clear the cart
    let loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (loggedInUser) {
        loggedInUser.cart = [];
        localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
    }

    // Redirect to a confirmation page or show a success message
    closeShippingForm();

    // Update the cart display
    updateCart();
});

// hàm thanh toán
function checkout() {
    console.log('Checkout button clicked'); // Add this line to check if the button is clicked
    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (!loggedInUser || !loggedInUser.cart || loggedInUser.cart.length === 0) {
        console.log('No logged-in user or cart is empty'); // Add this line to check if the user is logged in and cart is not empty
        return;
    }

    if (!loggedInUser) {
        alert('Bạn cần đăng nhập để thanh toán.');
        return;
    }
    // Redirect to the shipping information form
    console.log('Calling showShippingForm'); // Add this line to check if showShippingForm is being called
    showShippingForm();
    updateCart();
}

// Gọi hàm cập nhật giỏ hàng khi tải trang
window.onload = function () {
    localStorage.removeItem('loggedInUser');
    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if (loggedInUser) {
        updateCart();
    }
};



// Đảm bảo các phần tử tồn tại trước khi thêm sự kiện
document.addEventListener('DOMContentLoaded', () => {

    const cartButton = document.querySelector('.fa-shopping-cart').parentElement;
    const checkoutButton = document.getElementById('checkout-btn');

    if (cartButton) {
        cartButton.addEventListener('click', openCart);
    }

    if (checkoutButton) {
        console.log('Attaching checkout event listener'); // Add this line to check if the event listener is being attached
        checkoutButton.addEventListener('click', checkout);
    }
});